import{_ as s,c as n,o as a,a as l}from"./app.c70240ad.js";const o="/assets/å¦‚ä½•åŒºåˆ†mountå’Œupdate.aa04f89d.jpg",d=JSON.parse('{"title":"å®ç°é¦–å±æ¸²æŸ“","description":"","frontmatter":{},"headers":[{"level":2,"title":"å‰è¨€","slug":"å‰è¨€","link":"#å‰è¨€","children":[]},{"level":2,"title":"å‰ç½®çŸ¥è¯† -- Fiber Flags çš„åˆ†ç±»","slug":"å‰ç½®çŸ¥è¯†-fiber-flags-çš„åˆ†ç±»","link":"#å‰ç½®çŸ¥è¯†-fiber-flags-çš„åˆ†ç±»","children":[]},{"level":2,"title":"é¢„å¤‡å·¥ä½œ -- æ·»åŠ  __DEV__ å…¨å±€æ ‡è¯†","slug":"é¢„å¤‡å·¥ä½œ-æ·»åŠ -dev-å…¨å±€æ ‡è¯†","link":"#é¢„å¤‡å·¥ä½œ-æ·»åŠ -dev-å…¨å±€æ ‡è¯†","children":[]},{"level":2,"title":"beginWork","slug":"beginwork","link":"#beginwork","children":[{"level":3,"title":"updateHostRoot","slug":"updatehostroot","link":"#updatehostroot","children":[]},{"level":3,"title":"updateHostComponent","slug":"updatehostcomponent","link":"#updatehostcomponent","children":[]},{"level":3,"title":"reconcileChildren","slug":"reconcilechildren","link":"#reconcilechildren","children":[]}]},{"level":2,"title":"completeWork","slug":"completework","link":"#completework","children":[{"level":3,"title":"ä¸ºä»€ä¹ˆæ˜¯åœ¨ completeWork æ—¶æ„å»ºç¦»å± DOM æ ‘ï¼Ÿ","slug":"ä¸ºä»€ä¹ˆæ˜¯åœ¨-completework-æ—¶æ„å»ºç¦»å±-dom-æ ‘","link":"#ä¸ºä»€ä¹ˆæ˜¯åœ¨-completework-æ—¶æ„å»ºç¦»å±-dom-æ ‘","children":[]},{"level":3,"title":"ä¸ºä»€ä¹ˆè¦è®°å½•æ¯ä¸ª fiber çš„å­æ ‘ flagsï¼Ÿ","slug":"ä¸ºä»€ä¹ˆè¦è®°å½•æ¯ä¸ª-fiber-çš„å­æ ‘-flags","link":"#ä¸ºä»€ä¹ˆè¦è®°å½•æ¯ä¸ª-fiber-çš„å­æ ‘-flags","children":[]},{"level":3,"title":"appendAllChildren -- æ„å»º DOM Tree","slug":"appendallchildren-æ„å»º-dom-tree","link":"#appendallchildren-æ„å»º-dom-tree","children":[]},{"level":3,"title":"flags å†’æ³¡","slug":"flags-å†’æ³¡","link":"#flags-å†’æ³¡","children":[]}]},{"level":2,"title":"å¯¹æ¥ commitRoot","slug":"å¯¹æ¥-commitroot","link":"#å¯¹æ¥-commitroot","children":[]}],"relativePath":"react-learning/plasticine-react/05-first-screen-rendering/index.md","lastUpdated":1675946878000}'),p={name:"react-learning/plasticine-react/05-first-screen-rendering/index.md"},e=l(`<h1 id="å®ç°é¦–å±æ¸²æŸ“" tabindex="-1">å®ç°é¦–å±æ¸²æŸ“ <a class="header-anchor" href="#å®ç°é¦–å±æ¸²æŸ“" aria-hidden="true">#</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>æœ¬ç¯‡æ–‡ç« å¯¹åº”ä»£ç å¯ä»¥åˆ° <a href="https://github.com/plasticine-yang/plasticine-react/tree/03_first-screen-rendering" target="_blank" rel="noreferrer">03_first-screen-rendering</a> åˆ†æ”¯æŸ¥çœ‹</p></div><h2 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a></h2><p>æœ¬ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„æ˜¯å®ç°é¦–å±æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯ <code>mount</code> çš„æµç¨‹ï¼Œå¯¹äº mount çš„æµç¨‹å®é™…ä¸Šæ˜¯å¤ç”¨äº†æ›´æ–°æµç¨‹çš„ï¼Œå¹¶æ²¡æœ‰å•ç‹¬å®ç°ä¸€ä¸ªä¸“é—¨çš„ mount æµç¨‹ï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•å¤ç”¨æ›´æ–°æµç¨‹çš„å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬ç¯‡æ–‡ç« è¦æ¢è®¨çš„å†…å®¹äº†</p><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ä¸€ä¸‹æ›´æ–°æµç¨‹ä¼šåšä»€ä¹ˆäº‹ï¼š</p><ol><li><strong>ç”Ÿæˆ wip fiber tree</strong></li><li><strong>ä¸º fiber tree ä¸­çš„ fiber èŠ‚ç‚¹æ ‡è®°å‰¯ä½œç”¨ flags</strong></li></ol><p>ä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤å°±æ˜¯æ›´æ–°æµç¨‹çš„æ ¸å¿ƒç›®çš„ï¼Œåœ¨å®Œæˆäº†è¿™ä¸¤æ­¥ä¹‹åï¼Œå°±å¯ä»¥äº¤ç»™ commit é˜¶æ®µï¼Œæ ¹æ®æ¯ä¸ªèŠ‚ç‚¹çš„å‰¯ä½œç”¨ flags å»åšå‡ºç›¸åº”å¤„ç†</p><p>é‚£ä¹ˆ mount çš„æ—¶å€™ï¼Œwip fiber tree å¹¶ä¸å­˜åœ¨ï¼Œè¿™å°±éœ€è¦é€šè¿‡é€’å½’çš„æ–¹å¼å»ç”Ÿæˆ fiber treeï¼Œå¹¶ä¸”åœ¨ç»™æ¯ä¸ª fiber tree æ‰“ä¸Šå‰¯ä½œç”¨ flags çš„æ—¶å€™ï¼Œä¸ºå®ƒä»¬éƒ½æ‰“ä¸Š <code>Placement</code> æ ‡è®°ï¼Œä¹Ÿå°±æ˜¯ä»£è¡¨ç€è¦æ’å…¥ fiber å¯¹åº”çš„ ReactElementï¼Œè¿™æ ·ä¸å°±å®ç° mount äº†ä¹ˆï¼Ÿ</p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº mount æµç¨‹ï¼Œå®Œå…¨å¯ä»¥å¤ç”¨æ›´æ–°çš„æµç¨‹ï¼Œæ‰€ä»¥ React ä¸­æ²¡æœ‰å¿…è¦å•ç‹¬å®ç°ä¸€å¥— mount çš„æµç¨‹ï¼Œä½†æ˜¯ä¸Šé¢è¿™ä¸ªåªæ˜¯æˆ‘ä»¬ç›®å‰åˆæ­¥çš„æƒ³æ³•ï¼Œå®é™…ä¸Šåœ¨ React ä¸­æ˜¯å¦çœŸçš„æ˜¯è¿™æ ·å®ç°çš„å‘¢ï¼Ÿ</p><p>åœ¨ React ä¸­ï¼Œå¤§è‡´æµç¨‹å’Œæˆ‘ä»¬ä¸Šé¢æè¿°çš„ä¸€è‡´ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç‚¹ä¸ä¸€æ ·ã€‚React åœ¨ mount æ—¶å¹¶ä¸ä¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰“ä¸Š <code>Placement</code> æ ‡è®°ï¼Œåªä¼šä¸º <code>hostRootFiber</code> æ‰“ä¸Š <code>Placement</code> æ ‡è®°ï¼Œé‚£ä½ å¯èƒ½å°±ä¼šå¥½å¥‡è¿™æ ·çš„è¯ fiber tree çš„å…¶ä½™å­èŠ‚ç‚¹è¦æ€ä¹ˆåœ¨ commit é˜¶æ®µå®é™…æ¸²æŸ“åˆ° UI ä¸­å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜å°±è¦åœ¨è¯»å®Œæœ¬ç¯‡æ–‡ç« åæ‰èƒ½çŸ¥æ™“äº†</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¦åšä»€ä¹ˆï¼Œä¸Šç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å®é™…ä¸Šåªæ˜¯æ­å»ºäº†æ•´ä¸ªæ›´æ–°æµç¨‹çš„åŸºæœ¬éª¨æ¶ï¼Œä½†æ˜¯å®é™…çš„ <code>ç”Ÿæˆ wip fiber tree</code> å’Œ <code>ä¸º fiber tree ä¸­çš„ fiber èŠ‚ç‚¹æ ‡è®°å‰¯ä½œç”¨ flags</code> è¿™ä¸¤ä¸ªæ ¸å¿ƒæ­¥éª¤å¹¶æ²¡æœ‰å®ç°</p><p>è€Œè¿™ä¸¤ä¸ªå®é™…ä¸Šæ˜¯åˆ†åˆ«åœ¨é€’å½’çš„ <code>é€’</code> å’Œ <code>å½’</code> ä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯åˆ†åˆ«åœ¨ <code>beginWork</code> å’Œ <code>completeWork</code> ä¸­å®Œæˆï¼Œå› åŠ æ¥ä¸‹æ¥æˆ‘ä»¬çš„é‡ç‚¹å…ˆæ”¾åˆ°è¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°ä¸Š</p><h2 id="å‰ç½®çŸ¥è¯†-fiber-flags-çš„åˆ†ç±»" tabindex="-1">å‰ç½®çŸ¥è¯† -- Fiber Flags çš„åˆ†ç±» <a class="header-anchor" href="#å‰ç½®çŸ¥è¯†-fiber-flags-çš„åˆ†ç±»" aria-hidden="true">#</a></h2><p>å¯¹äº <code>Fiber Flags</code>ï¼Œæˆ‘ä»¬å°†å…¶åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>ç»“æ„å˜åŒ–ç›¸å…³ï¼šæ¯”å¦‚ <code>Placement</code>ã€<code>ChildDeletion</code> è¿™ç§ä¼šä¿®æ”¹æ•´ä¸ª fiber tree ç»“æ„çš„ flags</li><li>å±æ€§å˜åŒ–ç›¸å…³ï¼šæ¯”å¦‚ <code>Update</code> è¿™ç§å¯¹ fiber tree çš„ç»“æ„æ²¡å½±å“ï¼Œè€Œæ˜¯å½±å“åˆ°å…·ä½“ fiber çš„ props çš„</li></ul><p><strong>åœ¨ <code>beginWork</code> æ—¶ä¸ºç”Ÿæˆçš„ fiber æ‰“ä¸Šçš„æ ‡è®°éƒ½æ˜¯ç»“æ„å˜åŒ–ç›¸å…³çš„ï¼Œåœ¨ <code>completeWork</code> æ—¶ä¸º fiber æ‰“ä¸Šçš„æ ‡è®°åˆ™æ˜¯å±æ€§å˜åŒ–ç›¸å…³çš„</strong></p><h2 id="é¢„å¤‡å·¥ä½œ-æ·»åŠ -dev-å…¨å±€æ ‡è¯†" tabindex="-1">é¢„å¤‡å·¥ä½œ -- æ·»åŠ  <code>__DEV__</code> å…¨å±€æ ‡è¯† <a class="header-anchor" href="#é¢„å¤‡å·¥ä½œ-æ·»åŠ -dev-å…¨å±€æ ‡è¯†" aria-hidden="true">#</a></h2><p>åœ¨å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åšä¸€ä¸ªé¢„å¤‡å·¥ä½œ -- ä¸ºé¡¹ç›®æ·»åŠ  <code>__DEV__</code> å…¨å±€æ ‡è¯†</p><p>ä¸ºä»€ä¹ˆè¦æ·»åŠ è¿™ä¸ªæ ‡è¯†å‘¢ï¼Ÿé¦–å…ˆä»å…¶åå­—å°±èƒ½çŸ¥é“å®ƒæ˜¯æ ‡è¯†å½“å‰ä»£ç æ˜¯å¦è¿è¡Œåœ¨å¼€å‘ç¯å¢ƒä¸‹çš„ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å¼€å‘ç¯å¢ƒä¸‹èƒ½å¤Ÿä¸ºä½¿ç”¨è€…æä¾›ä¸€äº›è­¦å‘Šä¿¡æ¯ï¼Œè€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹è¿™äº›è­¦å‘Šä¿¡æ¯åˆ™ä¸è¾“å‡º</p><p>é‚£ä¹ˆä½ å¯èƒ½ä¼šé—®ï¼Œâ€œæˆ‘ç›´æ¥ç”¨ <code>p<wbr>rocess.env.NODE_ENV</code>â€ å»æ ‡è¯†ä¸å°±å¥½äº†ï¼Œè¿™æ ·ç¡®å®æ˜¯å¯ä»¥ï¼Œä½†æ˜¯æ¯æ¬¡æˆ‘ä»¬åœ¨é‡åˆ°è¿™ç§åŒºåˆ†å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åœºæ™¯æ—¶ï¼Œéƒ½è¦å†™è¿™ä¹ˆä¸€é•¿ä¸²çš„è¯å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥é‡‡ç”¨è¿™ç§å…¨å±€æ ‡è¯†çš„æ–¹å¼å®ç°ï¼Œå¼€å‘ä½“éªŒä¼šæ›´å¥½ï¼Œäº‹å®ä¸Šï¼Œåœ¨ React å’Œ Vue ä¸­éƒ½æ˜¯è¿™ä¹ˆåšçš„ï¼Œé‚£ä¹ˆè¦å¦‚ä½•å®ç°è¿™æ ·çš„å…¨å±€æ ‡è¯†å‘¢ï¼Ÿ</p><p>ç”±äºæˆ‘ä»¬çš„æ‰“åŒ…å·¥å…·ç”¨çš„æ˜¯ <code>rollup</code>ï¼Œæ°å¥½ rollup ç¤¾åŒºä¸­æœ‰ä¸€ä¸ªåä¸º <code>@rollup/plugin-replace</code> çš„å®˜æ–¹æ’ä»¶å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®˜æ–¹æ–‡æ¡£ä»‹ç»å¦‚ä¸‹ï¼š</p><blockquote><p>ğŸ£ A Rollup plugin which replaces targeted strings in files while bundling.</p></blockquote><p>å®ƒèƒ½å¤Ÿåœ¨æ‰“åŒ…çš„æ—¶å€™è¯†åˆ«é…ç½®çš„å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶æ›¿æ¢æˆé…ç½®çš„å€¼ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬èƒ½å¤Ÿé…ç½®ç±»ä¼¼ <code>__DEV__: p<wbr>rocess.env.NODE_ENV === &#39;development&#39; ? true : false</code> è¿™æ ·çš„é…ç½®é¡¹ï¼Œè¿™æ ·å°±å¯ä»¥è¿›è¡ŒåŒºåˆ†äº†</p><p>å¹¶ä¸”ç»“åˆ rollup çš„ <code>deadcode elimination</code> èƒ½åŠ›ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä»£ç ä¸­çš„ <code>if (__DEV__) {}</code> éƒ½ä¼šè¢«æ’ä»¶æ›¿æ¢æˆ <code>if (false) {}</code>ï¼Œä»è€Œä¸ä¼šå°†å…¶æ‰“åŒ…åˆ°äº§ç‰©ä¸­ï¼Œå‡å°æ‰“åŒ…ä½“ç§¯</p><p>é¦–å…ˆå®‰è£…è¯¥æ’ä»¶ï¼š</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-C</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">packages/cli</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">@rollup/plugin-replace</span></span>
<span class="line"></span></code></pre></div><p>ç„¶åæ·»åŠ ç›¸åº”é…ç½®ï¼š</p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createReplaceConfig</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RollupBuildConfig</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">replaceConfig</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">RollupReplaceOptions</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ============== plugin config ==============</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Prevents replacing strings where they are followed by a single equals sign.</span></span>
<span class="line"><span style="color:#F07178;">    preventAssignment</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ============== replace values ==============</span></span>
<span class="line"><span style="color:#F07178;">    __DEV__</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">replaceConfig</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç”±äºè¦åœ¨ TypeScript ä¸­ä½¿ç”¨ <code>__DEV__</code> è¿™æ ·ä¸€ä¸ªå…¨å±€æ ‡è¯†ï¼Œè€Œ TypeScript å¹¶ä¸çŸ¥é“å®ƒæ˜¯ä¸ªå•¥ç©æ„å„¿ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸ºå…¶æ·»åŠ ç±»å‹å£°æ˜ï¼Œåœ¨ <code>packages/react-reconciler/src</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>reconciler.d.ts</code> æ–‡ä»¶</p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/** </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> å…¨å±€æ ‡è¯†æ˜¯å¦åœ¨å¼€å‘ç¯å¢ƒä¸­ */</span></span>
<span class="line"><span style="color:#C792EA;">declare</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> __DEV__</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span></span>
<span class="line"></span></code></pre></div><p>ç„¶åæˆ‘ä»¬åœ¨ <code>react-reconciler</code> åŒ…çš„å…¥å£ä¸­éšä¾¿å¯¼å‡ºä¸ªå˜é‡ï¼Œå¹¶ä¸”å…¶å€¼è®¾ç½®ä¸º <code>__DEV__</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> foo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> __DEV__</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">foo</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>æ‰§è¡Œ <code>pnpm build react-reconciler</code> çœ‹çœ‹æ‰“åŒ…äº§ç‰©</p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> foo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">foo</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>å†æ‰§è¡Œ <code>pnpm build react-reconciler --mode=production</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> foo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">foo</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>æ‰“åŒ…åŠŸèƒ½æ­£å¸¸ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥å»å®ç° <code>beginWork</code> å’Œ <code>completeWork</code> å•¦~</p><h2 id="beginwork" tabindex="-1">beginWork <a class="header-anchor" href="#beginwork" aria-hidden="true">#</a></h2><p>é¦–å…ˆè¦æ˜ç¡®ä¸€ä¸‹ <code>beginWork</code> çš„ç›®çš„ï¼š</p><ol><li>ç”Ÿæˆä¸‹ä¸€ä¸ª fiber</li><li>ä¸ºç”Ÿæˆçš„ fiber æ‰“ä¸Šæ ‡è®°</li></ol><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œç¬¬äºŒä¸ªç›®çš„éœ€è¦åŒºåˆ†æ‰€å¤„é˜¶æ®µæ˜¯ <code>mount</code> æ—¶è¿˜æ˜¯ <code>update</code> æ—¶ï¼Œ<code>mount</code> æ—¶æ˜¯ä¸éœ€è¦æ‰“ä¸Šæ ‡è®°çš„ï¼Œè¿™ä¸ªç¨åä¼šè¯¦ç»†è®¨è®º</p></div><p>beginWork ä½œç”¨çš„å¯¹è±¡æ˜¯ FiberNodeï¼Œè€Œ FiberNode æœ‰å¤šç§ç±»å‹ï¼Œæ¯”å¦‚ <code>HostRoot</code>ã€<code>HostComponent</code>ã€<code>HostText</code>ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦æ ¹æ® FiberNode çš„ç±»å‹å»æ‰§è¡Œä¸åŒçš„å¤„ç†å‡½æ•°</p><p><code>packages/react-reconciler/src/begin-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> å¼€å§‹æ¶ˆè´¹å·¥ä½œå•å…ƒ æ¶ˆè´¹å®Œååº”å½“è¿”å› child ä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">beginWork</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostRoot</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostComponent</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostText</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">beginWork: å°šæœªå®ç°çš„ beginWork æƒ…å†µ</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="updatehostroot" tabindex="-1">updateHostRoot <a class="header-anchor" href="#updatehostroot" aria-hidden="true">#</a></h3><p>å› ä¸ºç°åœ¨æˆ‘ä»¬çš„ç›®çš„æ˜¯å®ç° mount æµç¨‹ï¼Œæ‰€ä»¥å…ˆä» HostRoot ç±»å‹çš„ FiberNode å¼€å§‹ä¸‹æ‰‹ï¼Œå®ç°ä¸€ä¸ª <code>updateHostRoot</code> çš„å‡½æ•°ï¼Œå…¶ç›®æ ‡èŠ‚ç‚¹æ˜¯ HostRoot ä¹Ÿå°±æ˜¯ hostRootFiberï¼Œæ˜¯æ•´ä¸ªé€’å½’æµç¨‹çš„èµ·ç‚¹</p><p>ä»»åŠ¡æ˜¯å¯¹æ¯” <code>æ—§çš„å­ FiberNode</code> å’Œ <code>æ–°çš„å­ ReactElement</code>ï¼Œå¹¶ç”Ÿæˆ <code>æ–°çš„å­ FiberNode</code> è¿”å›ä½œä¸ºä¸‹ä¸€ä¸ª beginWork çš„å·¥ä½œå•å…ƒ</p><p><code>æ—§çš„å­ FiberNode</code> å¯ä»¥ä» <code>hostRootFiber.alternate.child</code> è·å–</p><p><code>æ–°çš„å­ ReactElement</code> åˆ™éœ€è¦é€šè¿‡æ¶ˆè´¹ update å¯¹è±¡è·å¾—ï¼Œupdate å¯¹è±¡ä»å“ªé‡Œæ¥ï¼Ÿ</p><p>æˆ‘ä»¬å›åˆ° mount æµç¨‹çš„å…¥å£ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ <code>createRoot(container).render(&lt;App /&gt;)</code> çš„ render æ–¹æ³•æ—¶è°ƒç”¨çš„ <code>updateContainer</code> ä¸­ï¼Œå®ƒä¼šä¸º <code>&lt;App /&gt;</code> åˆ›å»ºä¸€ä¸ª <code>Update</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ <code>action</code> å°±æ˜¯ <code>&lt;App /&gt;</code> å¯¹åº”çš„ ReactElement</p><p>å›é¡¾ä¸€ä¸‹æ¶ˆè´¹ update çš„å®ç° -- <code>processUpdateQueue</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ProcessUpdateQueueReturnType</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">memoizedState</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> æ¶ˆè´¹ä¸€ä¸ª Update å¯¹è±¡ -- å°† baseState äº¤ç»™ Update æ¶ˆè´¹åè¿”å›æ–°çš„ state</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">processUpdateQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">&gt;(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">baseState</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">pendingUpdate</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Update</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ProcessUpdateQueueReturnType</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ProcessUpdateQueueReturnType</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">State</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    memoizedState</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseState</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">pendingUpdate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">action</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pendingUpdate</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">action</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">action</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">instanceof</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Function</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// baseState -- 1 | update -- (x) =&gt; x + 1 --&gt; memoizedState -- 2</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">action</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">baseState</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// baseState -- 1 | update -- 6 --&gt; memoizedState -- 6</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">action</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç”±äºä¸º <code>&lt;App /&gt;</code> åˆ›å»ºçš„ update å¯¹è±¡çš„ action æ˜¯ä¸€ä¸ªå€¼è€Œä¸æ˜¯å‡½æ•°ï¼Œæ‰€ä»¥æ¶ˆè´¹åå¾—åˆ°çš„ç»“æœå°±æ˜¯ <code>&lt;App /&gt;</code> è¿™ä¸ª ReactElement æœ¬èº«ï¼Œå³ <code>æ–°çš„å­ ReactElement</code></p><p>è¯¦ç»†æµç¨‹æ”¾åœ¨ä»£ç æ³¨é‡Šä¸­è¯´æ˜</p><p><code>packages/react-reconciler/src/begin-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-diff"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> å¤„ç† HostRoot çš„ FiberNode</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸­å¾…è°ƒå’Œçš„ hostRootFiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateHostRoot</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å– workInProgress çš„ baseState å’Œå¾…æ¶ˆè´¹çš„ update</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ReactElement</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">UpdateQueue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// pending æ˜¯ Update&lt;Element&gt; ä¹Ÿå°±æ˜¯å¾…æ¶ˆè´¹çš„ update</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ¶ˆè´¹ update -- å¾—åˆ°çš„ memoizedState å°±æ˜¯ updateContainer æ—¶ä¸º \`&lt;App /&gt;\` åˆ›å»ºçš„ Update å¯¹è±¡ä¸­çš„ actionï¼Œä¹Ÿå°±æ˜¯ \`&lt;App /&gt;\` æœ¬èº«</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä¹Ÿå°±æ˜¯è¯´ mount æ—¶ï¼Œè¿™é‡Œå¾—åˆ°çš„ memoizedState å°±æ˜¯ \`&lt;App /&gt;\` å¯¹åº”çš„ ReactElement</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">processUpdateQueue</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">baseState</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// update æ¶ˆè´¹å®Œæ¯•åå°†å…¶æ›´æ–°åˆ° workInProgress ä¸­ -- æ­¤æ—¶ hostRootFiber.memoizedState === &lt;App /&gt;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">memoizedState</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// update æ¶ˆè´¹å®Œåéœ€è¦å°†å…¶æ¸…ç©º</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">shared</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pending</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ¥ä¸‹æ¥éœ€è¦è·å–åˆ° \`å­ current FiberNode\` å’Œ \`å­ ReactElement\` è¿›è¡Œå¯¹æ¯”ï¼Œå¹¶å¾—åˆ°æ–°çš„ \`å­ FiberNode\`</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¿™é‡Œå…¶å®å°±æ˜¯ä¸€ä¸ª diff ç®—æ³•çš„è¿‡ç¨‹äº†</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// \`å­ current FiberNode\` æ˜¯æ—§ FiberNode</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// \`å­ ReactElement\`  æ˜¯æ–° ReactElement</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ç›®çš„æ˜¯ç”Ÿæˆæ–°çš„å­ FiberNodeï¼Œè¿™ä¸ªè¿‡ç¨‹äº¤ç»™ \`reconcileChildren\` å‡½æ•°å»å¤„ç†</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextChildren</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å­ ReactElement</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å­ current FiberNode å¯ä»¥é€šè¿‡ workInProgress.alternate.children è·å–</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä¹Ÿå°±æ˜¯ FiberRootNode.current.children</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">reconcileChildren</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextChildren</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// reconcileChildren æ‰§è¡Œå®Œåä¼šå°†æ–°çš„å­ FiberNode æŒ‚åˆ° workInProgress.child ä¸Šï¼Œå°†å…¶è¿”å›å³å¯ä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">æ€è€ƒ</p><p>è¿™é‡Œä¸ºä»€ä¹ˆè¦æœ‰ <code>reconcileChildren</code> è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿç›´æ¥æŠŠå¯¹æ¯”é€»è¾‘å†™åœ¨ <code>updateHostRoot</code> å‡½æ•°é‡Œä¸å°±å¯ä»¥äº†å—ï¼Ÿ</p></div><details class="details custom-block"><summary>æŸ¥çœ‹ç­”æ¡ˆ</summary><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜è¦è€ƒè™‘åˆ°ä¹‹åå¯¹å…¶ä»–ç±»å‹çš„ FiberNode è¿›è¡Œå¤„ç†çš„æ—¶å€™ä¹Ÿä¼šæœ‰ <code>å¯¹æ¯”å­èŠ‚ç‚¹è·å–æ–°å­èŠ‚ç‚¹</code> çš„è¿™æ ·ä¸€ä¸ªé€»è¾‘ï¼Œæ¯”å¦‚ç¨åè¦å®ç°çš„ <code>updateHostComponent</code> å°±é©¬ä¸Šä¼šç”¨åˆ°ï¼Œå› æ­¤é€‚åˆå°†å…¶æŠ½ç¦»æˆä¸€ä¸ªå•ç‹¬çš„å‡½æ•°å»å®ç°</p></details><h3 id="updatehostcomponent" tabindex="-1">updateHostComponent <a class="header-anchor" href="#updatehostcomponent" aria-hidden="true">#</a></h3><p>ä»¥ <code>react-dom</code> ä¸ºä¾‹ï¼ŒHostComponent æŒ‡çš„å°±æ˜¯è¯¸å¦‚ <code>&lt;div&gt;hello&lt;/div&gt;</code> è¿™æ ·çš„æ™®é€š DOM å…ƒç´ ï¼Œæˆ‘ä»¬è¦è°ƒç”¨ <code>reconcileChildren</code> å»å¯¹æ¯” DOM å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œé‚£å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•è·å–åˆ° <code>reconcileChildren</code> æ‰€éœ€çš„ç¬¬äºŒä¸ªå‚æ•° -- <code>nextChildren</code> å‘¢ï¼Ÿ</p><details class="details custom-block"><summary>æŸ¥çœ‹ç­”æ¡ˆ</summary><p>å›å¿†æˆ‘ä»¬åœ¨ä½¿ç”¨ React çš„æ—¶å€™ï¼Œå¦‚ä½•è·å–åˆ°ä¸€ä¸ª DOM å…ƒç´ çš„ children?</p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> foo </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> &lt;</span><span style="color:#FFCB6B;">div</span><span style="color:#A6ACCD;">&gt;foo</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(foo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">props</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">children) </span><span style="color:#676E95;font-style:italic;">// foo</span></span>
<span class="line"></span></code></pre></div><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»å…¶ fiber çš„ <code>pendingProps.children</code> ä¸­è·å–åˆ° <code>nextChildren</code></p></details><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><p><code>packages/react-reconciler/src/begin-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> å¤„ç† HostComponent çš„ FiberNode</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸­å¾…è°ƒå’Œçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateHostComponent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pendingProps</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextChildren</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextProps</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">children</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">reconcileChildren</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextChildren</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç›¸è¾ƒäº <code>updateHostRoot</code>ï¼Œä¸»è¦æ˜¯è·å– <code>nextChildren</code> çš„æ–¹å¼ä¸åŒï¼š</p><ul><li>updateHostRoot: é€šè¿‡è°ƒç”¨ <code>processUpdateQueue</code> æ¶ˆè´¹ update è·å– nextChildren</li><li>updateHostComponent: é€šè¿‡ <code>pendingProps</code> è·å– nextChildren</li></ul><p>åç»­æµç¨‹åˆ™éƒ½æ˜¯ä¸€æ ·çš„ï¼Œäº¤ç”± <code>reconcileChildren</code> å¤„ç†</p><p>è‡³äº <code>HostText</code>ï¼Œç›´æ¥è¿”å› <code>null</code> å³å¯ï¼Œå› ä¸ºå…¶ä¸å­˜åœ¨å­èŠ‚ç‚¹äº†ï¼Œä¸èƒ½ä¹Ÿæ²¡å¿…è¦è°ƒç”¨ <code>reconcileChildren</code></p><h3 id="reconcilechildren" tabindex="-1">reconcileChildren <a class="header-anchor" href="#reconcilechildren" aria-hidden="true">#</a></h3><p>å‰é¢å·²ç»å®ç°äº† beginWork äº†ï¼Œä½†å…¶å®å®ƒçš„æ ¸å¿ƒåœ¨äºå®ç° <code>reconcileChildren</code>ï¼Œè¯¥å‡½æ•°æ‰æ˜¯ <code>é€’</code> é˜¶æ®µçš„æ ¸å¿ƒ</p><p>å…ˆæ¥æ˜ç¡®ä¸€ä¸‹ reconcileChildren çš„ä»»åŠ¡ï¼š</p><ul><li>æ¥æ”¶ <code>workInProgress</code> å’Œ <code>å¾…è°ƒå’Œçš„ children</code>ï¼šå¯ä»¥ä» workInProgress ä¸­è·å–æ—§ children fiberï¼Œè€Œæ–° children åˆ™æ˜¯ ReactElement</li><li>å¯¹æ¯”ä¸¤è€…è¿›è¡Œ diff ç®—æ³•ï¼Œå¹¶ä¸ºæ–° children ç”Ÿæˆ fiber è¿”å›</li></ul><p>æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä» workInProgress ä¸­è·å–æ—§ children fiberï¼Œä¹Ÿå°±æ˜¯ <code>workInProgress.alternate.child</code></p><p>åœ¨å®ç°ç¬¬äºŒä¸ªæ ¸å¿ƒä»»åŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ¢è®¨ä¸‹è¿™ä¸ªè¿‡ç¨‹æ˜¯å¦æœ‰å¯ä¼˜åŒ–çš„åœ°æ–¹</p><h4 id="æ€§èƒ½ä¼˜åŒ–ç­–ç•¥-mount-æ—¶è¿›è¡Œç¦»å±æ¸²æŸ“" tabindex="-1">æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ -- mount æ—¶è¿›è¡Œç¦»å±æ¸²æŸ“ <a class="header-anchor" href="#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥-mount-æ—¶è¿›è¡Œç¦»å±æ¸²æŸ“" aria-hidden="true">#</a></h4><p>ç†è®ºä¸Šï¼Œmount é˜¶æ®µæˆ‘ä»¬éœ€è¦åœ¨ reconcileChildren ä¸­ç”Ÿæˆ fiber tree çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºæ¯ä¸ª fiber æ‰“ä¸Š <code>Placement</code> æ ‡è®°ï¼Œæ‰èƒ½åœ¨ commit é˜¶æ®µå°†å®ƒä»¬æ¸²æŸ“åˆ° UI ä¸Šï¼Œä½†å®é™…ä¸Šè¿™é‡Œå­˜åœ¨ä¸€ä¸ªä¼˜åŒ–ç­–ç•¥</p><p>å¦‚æœæ˜¯ä¸€ä¸ªä¸ª fiber æ‰“ä¸Š Placement æ ‡è®°ï¼Œé‚£ä¹ˆåœ¨ commit çš„æ—¶å€™ï¼ŒUI ä¹Ÿå°†ä¼šæ˜¯ä¸€ä¸ªä¸ªæ¸²æŸ“å‡º fiber èŠ‚ç‚¹å¯¹åº”çš„ ReactElement çš„ï¼Œè¿™ä¼šé¢‘ç¹æ“ä½œ DOMã€‚ä½†å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥å°† <code>hostRootFiber</code> çš„å­èŠ‚ç‚¹è¿›è¡Œ <code>ç¦»å±æ¸²æŸ“</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…å­˜ä¸­å°†è¿™äº›çœŸå® DOM åˆ›å»ºå‡ºæ¥ï¼Œæœ€åå†ä¸€æ¬¡æ€§å°† <code>hostRootFiber</code> æ¸²æŸ“å‡ºæ¥ï¼Œé¿å…é¢‘ç¹åœ°æ“ä½œ DOM</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨æ‰“ <code>Placement</code> æ ‡è®°æ—¶ï¼Œåªç»™ <code>hostRootFiber</code> æ‰“ä¸Šè¯¥æ ‡è®°å³å¯ï¼Œå¯¹äºå…¶å­ fiber æˆ‘ä»¬ä¸æ ‡è®° <code>Placement</code>ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦æœ‰ä¸€ç§æœºåˆ¶å»å®ç°ä¸Šé¢è¯´çš„ <code>ç¦»å±æ¸²æŸ“</code> æ‰è¡Œï¼Œè€Œå¯¹äº update é˜¶æ®µï¼Œå°±æ²¡æœ‰è¿™æ ·çš„ä¼˜åŒ–ç­–ç•¥äº†</p><p>æ‰€ä»¥ reconcileChildren ä¸­éœ€è¦é’ˆå¯¹ mount å’Œ update é‡‡å–ä¸åŒçš„å®ç°ï¼Œåœ¨ mount æ—¶åªç»™ <code>hostRootFiber</code> æ‰“ä¸Š <code>Placement</code> æ ‡è®°ï¼Œå¯¹äºå…¶å­ fiber åˆ™ä¸è¿›è¡Œæ ‡è®°ï¼Œupdate åˆ™æ­£å¸¸æ ‡è®°ï¼Œç»™ fiber æ‰“ä¸Šæ ‡è®°è¿™ä¸€è¡Œä¸ºåœ¨ React ä¸­çš„ä¸“ä¸šæœ¯è¯­å«åš <strong>è¿½è¸ªå‰¯ä½œç”¨</strong></p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <strong>æ˜¯å¦è¿½è¸ªå‰¯ä½œç”¨</strong> æ¥åŒºåˆ† mount å’Œ update çš„ä¸¤ç§å®ç°</p><h4 id="å¦‚ä½•åŒºåˆ†-mount-å’Œ-update-é˜¶æ®µ" tabindex="-1">å¦‚ä½•åŒºåˆ† mount å’Œ update é˜¶æ®µ <a class="header-anchor" href="#å¦‚ä½•åŒºåˆ†-mount-å’Œ-update-é˜¶æ®µ" aria-hidden="true">#</a></h4><p>æ˜ç™½äº†ä¸Šé¢çš„æµç¨‹å’ŒåŸå› åï¼Œæˆ‘ä»¬è¦æ€è€ƒä¸€ä¸‹å¦‚ä½•åŒºåˆ† mount å’Œ update é˜¶æ®µå‘¢ï¼Ÿ</p><details class="details custom-block"><summary>æŸ¥çœ‹ç­”æ¡ˆ</summary><p>åˆ©ç”¨ mount æ—¶ <code>wip.alternate.child === null</code> ä¹Ÿå°±æ˜¯ current fiber tree ä¸­é™¤äº† <code>hostFiberRoot</code> å¤–è¿˜æ²¡æœ‰å­ fiber è¿™ä¸€ç‰¹ç‚¹è¿›è¡ŒåŒºåˆ†</p><p><img src="`+o+`" alt="å¦‚ä½•åŒºåˆ†mountå’Œupdate" data-fancybox="gallery"></p></details><h4 id="childreconciler" tabindex="-1">ChildReconciler <a class="header-anchor" href="#childreconciler" aria-hidden="true">#</a></h4><p>ä¸ºäº†åŒºåˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªä¸åŒçš„å®ç°ï¼Œåœ¨ React ä¸­ï¼Œmount å¯¹åº”çš„å®ç°åä¸º <code>mountChildFibers</code>ï¼Œupdate å¯¹åº”çš„å®ç°åä¸º <code>reconcileChildFibers</code></p><p>ç”±äºä¸¤è€…çš„å®ç°ä»…åœ¨äºæ˜¯å¦è¦ä¸ºç”Ÿæˆçš„ fiber æ‰“æ ‡è®°ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦è¦è¿½è¸ªå®ƒä»¬çš„å‰¯ä½œç”¨ï¼Œé™¤æ­¤ä¹‹å¤–çš„å…¶ä»–å®ç°æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤é€‚åˆç”¨é—­åŒ…çš„æ–¹å¼å»å®ç°</p><p>å®ç°ä¸€ä¸ª <code>ChildReconciler</code> å‡½æ•°ï¼Œå¹¶ä¸”å…¶æœ‰ä¸€ä¸ª <code>shouldTrackEffects</code> æ§åˆ¶æ˜¯å¦è¿½è¸ª fiber çš„å‰¯ä½œç”¨å±æ€§ï¼Œå…¶å†…éƒ¨çš„é—­åŒ…å‡½æ•°æ ¹æ® shouldTrackEffects å‚æ•°çš„å€¼å»æ§åˆ¶æ˜¯å¦è¦ä¸ºç”Ÿæˆçš„ fiber æ‰“æ ‡è®°ï¼Œå¹¶ä¸”ä¸»è¦çš„è°ƒå’Œé€»è¾‘ä¹Ÿæ˜¯åœ¨è¯¥é—­åŒ…å‡½æ•°å†…å®Œæˆ</p><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> ç”¨äºä¸º mount å’Œ update è°ƒå’Œ children æ—¶åšåŒºåˆ†</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *              mount æ—¶ä¸ºäº†ç¦»å±æ¸²æŸ“è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œåªä¸º hostRootFiber è¿½è¸ªå‰¯ä½œç”¨ï¼Œä¹Ÿå°±æ˜¯ç»™å…¶æ‰“ä¸Š Placement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *              update æ—¶åˆ™æ­£å¸¸è¿½è¸ªå‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">shouldTrackEffects</span><span style="color:#676E95;font-style:italic;"> æ˜¯å¦éœ€è¦è¿½è¸ª fiber çš„å‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ChildReconciler</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">shouldTrackEffects</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸Šå¾…è°ƒå’Œçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#676E95;font-style:italic;"> wip fiber å¯¹åº”çš„ current fiber tree ä¸­çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#676E95;font-style:italic;"> å¾…è°ƒå’Œçš„æ–° ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileChildFibers</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#89DDFF;">?:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">reconcileChildFibers</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> mount é˜¶æ®µè°ƒå’Œ children</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> mountChildFibers </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ChildReconciler</span><span style="color:#A6ACCD;">(</span><span style="color:#FF9CAC;">false</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> update é˜¶æ®µè°ƒå’Œ children</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> reconcileChildFibers </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ChildReconciler</span><span style="color:#A6ACCD;">(</span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mountChildFibers</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">reconcileChildFibers</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç„¶å <code>reconcileChildren</code> å°±å¯ä»¥åˆ†åˆ«ä¸º mount å’Œ update é˜¶æ®µè°ƒç”¨è¿™ä¸¤ä¸ªé—­åŒ…å‡½æ•°</p><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> è°ƒå’Œ children -- æ ¹æ® wip æ—§çš„å­ fiber å’Œ æ–°çš„ ReactElement ç”Ÿæˆæ–°çš„å­ fiberï¼Œå¹¶æŒ‚è½½åˆ° wip.child ä¸Š</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸Šå¾…è°ƒå’Œçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">children</span><span style="color:#676E95;font-style:italic;"> å¾…è°ƒå’Œçš„æ–° ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reconcileChildren</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">children</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è·å– wip fiber åœ¨ current fiber tree ä¸Šå¯¹åº”çš„ fiber -- ä¹Ÿå°±æ˜¯æ—§ fiber</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// mount æ—¶ä¸å­˜åœ¨æ—§ fiberï¼Œå³ current === nullï¼Œåˆ©ç”¨è¿™ç‚¹æ¥åŒºåˆ† mount å’Œ update</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// update</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileChildFibers</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">children</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    )</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// mount</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">mountChildFibers</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬çš„å…³æ³¨ç‚¹è½¬ç§»åˆ° <code>ChildReconciler</code> ä¸­ï¼Œä¸»è¦æ˜¯å®ç°å…¶å†…éƒ¨çš„ <code>reconcileChildFibers</code> å‡½æ•°ï¼Œå…¶ä¼šæ ¹æ® <code>newChild</code> çš„ä¸åŒæƒ…å†µå»è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°</p><ul><li>å¯¹äº ReactElement ä¼šè°ƒç”¨ <code>reconcileSingleElement</code> å‡½æ•°å»å¤„ç†</li><li>å¯¹äºçº¯æ–‡æœ¬å…ƒç´ ä¼šè°ƒç”¨ <code>reconcileSingleTextNode</code> å‡½æ•°å»å¤„ç†</li></ul><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸Šå¾…è°ƒå’Œçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#676E95;font-style:italic;"> wip fiber å¯¹åº”çš„ current fiber tree ä¸­çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#676E95;font-style:italic;"> å¾…è°ƒå’Œçš„æ–° ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ChildReconciler</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">shouldTrackEffects</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸Šå¾…è°ƒå’Œçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#676E95;font-style:italic;"> wip fiber å¯¹åº”çš„ current fiber tree ä¸­çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#676E95;font-style:italic;"> å¾…è°ƒå’Œçš„æ–° ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileChildFibers</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#89DDFF;">?:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ReactElement</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">object</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">newChild</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">$$typeof</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">REACT_ELEMENT_TYPE</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileSingleElement</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">reconcileChildFibers: å°šæœªæ”¯æŒçš„ ReactElement ç±»å‹</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#A6ACCD;">newChild</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            )</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// TODO å¤šèŠ‚ç‚¹ -- ul &gt; li*3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// HostText</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">number</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileSingleTextNode</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å°šæœªæ”¯æŒçš„ child</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">reconcileChildFibers: å°šæœªæ”¯æŒçš„ child</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileSingleElement</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileSingleTextNode</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">reconcileChildFibers</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>æˆ‘ä»¬é¦–å…ˆåªè€ƒè™‘ ReactElement å’Œ çº¯æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µï¼Œå…¶ä»–çš„ä¹‹åå†è¯´ï¼Œæ¥ä¸‹æ¥å»å®ç° <code>reconcileSingleElement</code> å’Œ <code>reconcileSingleTextNode</code> å‡½æ•°</p><h5 id="reconcilesingleelement-mount-æ—¶ç¦»å±æ¸²æŸ“çš„å…³é”®" tabindex="-1">reconcileSingleElement -- mount æ—¶ç¦»å±æ¸²æŸ“çš„å…³é”® <a class="header-anchor" href="#reconcilesingleelement-mount-æ—¶ç¦»å±æ¸²æŸ“çš„å…³é”®" aria-hidden="true">#</a></h5><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸º ReactElement åˆ›å»ºå¯¹åº”çš„ fiberï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå®ç°ä¸€ä¸ªæ ¹æ®ä¼ å…¥çš„ ReactElement è¿”å›å¯¹åº” fiber çš„å‡½æ•°</p><p><code>packages/react-reconciler/src/fiber.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> æ ¹æ®ä¼ å…¥çš„ ReactElement åˆ›å»ºå…¶å¯¹åº”çš„ FiberNode</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">element</span><span style="color:#676E95;font-style:italic;"> ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">returns</span><span style="color:#676E95;font-style:italic;"> FiberNode</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createFiberFromElement</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">element</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">type</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">props</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">element</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiberTag</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">WorkTag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">FunctionComponent</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// &lt;div&gt;hello&lt;/div&gt; --&gt; HostComponent</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">fiberTag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostComponent</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">createFiberFromElement: å°šæœªå®ç°çš„ ReactElement type ç±»å‹</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">element</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    )</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">FiberNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fiberTag</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">props</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">type</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç„¶åå°±æ˜¯ <code>reconcileSingleElement</code>ï¼Œè¿˜è®°å¾—è°ƒå’Œçš„æ ¸å¿ƒä»»åŠ¡æ˜¯ä»€ä¹ˆå—ï¼Ÿ</p><ul><li>ä¸ºå¾…è°ƒå’Œå…ƒç´ åˆ›å»º fiber</li><li>ç»™åˆ›å»ºçš„ fiber æ‰“ä¸Šç»“æ„å˜åŒ–ç›¸å…³çš„æ ‡è®°</li></ul><p>ç¬¬ä¸€ä¸ªæˆ‘ä»¬å·²ç»å®Œæˆäº†ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå‘¢ï¼Ÿè¿™å°±éœ€è¦å†å®ç°ä¸€ä¸ª <code>placeSingleChild</code> å‡½æ•°å»ä¸º fiber èŠ‚ç‚¹æ‰“ä¸Š <code>Placement</code> æ ‡è®°äº†ï¼Œç”±äºéœ€è¦è€ƒè™‘ mount å’Œ update æµç¨‹ä¸­æ˜¯å¦ä¸º fiber æ‰“ä¸Šæ ‡è®°ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°æˆ‘ä»¬åº”å½“æ”¾åˆ° <code>ChildReconciler</code> é—­åŒ…å‡½æ•°ä¸­å»å®ç°ï¼Œå› ä¸ºå¯ä»¥ä»è¯¥é—­åŒ…ç¯å¢ƒä¸­è·å–åˆ° <code>shouldTrackEffects</code> å‚æ•°</p><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> ä¸º fiber æ‰“ä¸Š \`Placement\` æ ‡è®°</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">fiber</span><span style="color:#676E95;font-style:italic;"> å¾…æ‰“ä¸Š \`Placement\` æ ‡è®°çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">returns</span><span style="color:#676E95;font-style:italic;"> å·²æ‰“ä¸Š \`Placement\`  æ ‡è®°çš„ fiber (åªåœ¨éœ€è¦çš„æ—¶å€™æ‰“ä¸Šæ ‡è®°)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">placeSingleChild</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">fiber</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">shouldtrackeffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// åªåœ¨åº”è¯¥è¿½è¸ªå‰¯ä½œç”¨ ä¸” fiber æ˜¯é¦–æ¬¡æ¸²æŸ“æ—¶æ‰éœ€è¦æ‰“ä¸Š Placement æ ‡è®°</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Placement</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å…¶ä½™æƒ…å†µä¸éœ€è¦æ‰“ä¸Š Placement æ ‡è®°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">mount æ—¶ç¦»å±æ¸²æŸ“çš„å…³é”®</p><p>è¿™é‡Œçš„ <code>if (shouldtrackeffects &amp;&amp; fiber.alternate === null)</code> æ˜¯ mount æ—¶ç¦»å±æ¸²æŸ“çš„å…³é”®ï¼Œmount æ—¶ <code>reconcileChildren</code> è°ƒç”¨çš„æ˜¯ <code>mountChildFibers</code>ï¼Œä¹Ÿå°±æ˜¯ <code>ChildReconciler(false)</code>ï¼Œå› æ­¤ mount æ—¶æ‰€æœ‰çš„å­ fiber ç”Ÿæˆåéƒ½ä¸ä¼šæ‰“ä¸Š Placement æ ‡è®°</p><p>é‚£æ‰€ä»¥æ•´ä¸ª UI è¦æ€ä¹ˆæ¸²æŸ“å‘¢ï¼Ÿå…³é”®ç‚¹å°±åœ¨ <code>hostRootFiber</code> èº«ä¸Šï¼Œç”±äº mount æ—¶æ•´ä¸ª wip fiber tree ä¸Šåªæœ‰ <code>hostRootFiber.alternate</code> ä¸æ˜¯ <code>null</code>ï¼Œæ‰€ä»¥å…¶ä¼šèµ° <code>reconcileChildFibers</code> è€Œä¸æ˜¯ <code>mountChildFibers</code>ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¼šä¸º <code>&lt;App /&gt;</code> å¯¹åº”çš„ fiber æ‰“ä¸Š <code>Placement</code> æ ‡è®°</p><p>è€Œæ•´ä¸ªç¦»å±æ¸²æŸ“åˆ™æ˜¯åœ¨ <code>completeWork</code> çš„æ—¶å€™å®Œæˆçš„ï¼Œå½“ <code>completeWork</code> æ‰§è¡Œåˆ° <code>hostRootFiber</code> æ—¶ï¼Œæ•´ä¸ªç¦»å± DOM Tree å·²ç»ç”Ÿæˆå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±åªéœ€è¦äº¤ç»™ commit é˜¶æ®µï¼Œå½“å…¶å‘ç° <code>&lt;App /&gt;</code> å¯¹åº”çš„ fiber æœ‰ <code>Placement</code> æ ‡è®°æ—¶ï¼Œå°±ä¼šä¸€æ¬¡æ€§å°†æ•´ä¸ªå†…å­˜ä¸­çš„ç¦»å± DOM Tree æŒ‚è½½åˆ°çœŸå® DOM ä¸­ï¼Œä»è€Œå®Œæˆæ¸²æŸ“ï¼Œè¿™æ ·å°±é¿å…äº† mount æ—¶å¯¹å­æ ‘èŠ‚ç‚¹ä¸€ä¸ªä¸€ä¸ªåœ°æ¸²æŸ“ï¼Œé€ æˆæ€§èƒ½æµªè´¹</p><p>å…·ä½“çš„ç¦»å± DOM Tree å¦‚ä½•ç”Ÿæˆæˆ‘ä»¬ä¼šåœ¨ completeWork çš„æ—¶å€™çŸ¥æ™“</p></div><p>å®Œæˆäº†ä»¥ä¸Šä¸¤ä¸ªæ ¸å¿ƒä»»åŠ¡åï¼Œ<code>reconcileSingleElement</code> å°±èƒ½å®ç°äº†</p><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> è°ƒå’Œ current fiber å’Œ ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">returnFiber</span><span style="color:#676E95;font-style:italic;"> ä¸º element åˆ›å»ºå‡ºçš„ fiber çš„ return æŒ‡å‘</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#676E95;font-style:italic;"> ä¸º element åˆ›å»ºå‡ºçš„ fiber çš„ alternate æŒ‡å‘</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">element</span><span style="color:#676E95;font-style:italic;"> å¾…åˆ›å»º fiber çš„ ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">returns</span><span style="color:#676E95;font-style:italic;"> ä¸º elemen åˆ›å»ºçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reconcileSingleElement</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">returnFiber</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">element</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä¸º element åˆ›å»º fiber</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createFiberFromElement</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">element</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">returnFiber</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="reconcilesingletextnode" tabindex="-1">reconcileSingleTextNode <a class="header-anchor" href="#reconcilesingletextnode" aria-hidden="true">#</a></h5><p>ç±»ä¼¼åœ°ï¼Œä¹Ÿèƒ½å¤Ÿå®ç° <code>reconcileSingleTextNode</code> äº†ï¼ŒåŒºåˆ«åªåœ¨äºä¸ºæ–‡æœ¬å…ƒç´ åˆ›å»º fiber æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦å•ç‹¬å®ç°ä¸€ä¸ªç±»ä¼¼ <code>createFiberFromElement</code> çš„å‡½æ•°ï¼Œç›´æ¥æ‰‹åŠ¨ new FiberNode å³å¯</p><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> è°ƒå’Œ current fiber å’Œ æ–‡æœ¬å…ƒç´ </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">returnFiber</span><span style="color:#676E95;font-style:italic;"> ä¸º content åˆ›å»ºå‡ºçš„ HostText ç±»å‹çš„ fiber çš„ return æŒ‡å‘</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#676E95;font-style:italic;"> ä¸º content åˆ›å»ºå‡ºçš„ HostText ç±»å‹çš„ fiber çš„ alternate æŒ‡å‘</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">content</span><span style="color:#676E95;font-style:italic;"> å¾…åˆ›å»º fiber çš„ æ–‡æœ¬å…ƒç´ å†…å®¹</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">returns</span><span style="color:#676E95;font-style:italic;"> ä¸º content åˆ›å»ºçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reconcileSingleTextNode</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">returnFiber</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">content</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä¸º content åˆ›å»º HostText ç±»å‹çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">FiberNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">HostText</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">returnFiber</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>æœ€åæˆ‘ä»¬å†æŠŠ <code>reconcileChildFibers</code> å®Œå–„ä¸‹å³å¯</p><p><code>packages/react-reconciler/src/child-fibers.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-focused-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ChildReconciler</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">shouldTrackEffects</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> wip fiber tree ä¸Šå¾…è°ƒå’Œçš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#676E95;font-style:italic;"> wip fiber å¯¹åº”çš„ current fiber tree ä¸­çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#676E95;font-style:italic;"> å¾…è°ƒå’Œçš„æ–° ReactElement</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">reconcileChildFibers</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">currentFiber</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;font-style:italic;">newChild</span><span style="color:#89DDFF;">?:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ReactElement</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ReactElement</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">object</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">newChild</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">$$typeof</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">REACT_ELEMENT_TYPE</span><span style="color:#89DDFF;">:</span></span>
<span class="line has-focus"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// ä¸º newChild ç”Ÿæˆ fiber å¹¶æ‰“ä¸Š Placement æ ‡è®° </span></span>
<span class="line has-focus"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">placeSingleChild</span><span style="color:#F07178;">( </span></span>
<span class="line has-focus"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">reconcileSingleElement</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">currentFiber</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#F07178;">          ) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">reconcileChildFibers: å°šæœªæ”¯æŒçš„ ReactElement ç±»å‹</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#A6ACCD;">newChild</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            )</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// TODO å¤šèŠ‚ç‚¹ -- ul &gt; li*3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// HostText</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">typeof</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">number</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line has-focus"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// ä¸º newChild ç”Ÿæˆ fiber å¹¶æ‰“ä¸Š Placement æ ‡è®° </span></span>
<span class="line has-focus"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">placeSingleChild</span><span style="color:#F07178;">( </span></span>
<span class="line has-focus"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">reconcileSingleTextNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">currentFiber</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#F07178;">      ) </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å°šæœªæ”¯æŒçš„ child</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">reconcileChildFibers: å°šæœªæ”¯æŒçš„ child</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newChild</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">reconcileChildFibers</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>è‡³æ­¤ï¼Œ<code>beginWork</code> çš„æµç¨‹å°±ç®—å®ç°å®Œå•¦~</p><h2 id="completework" tabindex="-1">completeWork <a class="header-anchor" href="#completework" aria-hidden="true">#</a></h2><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬ä¹Ÿè¦å…ˆæ˜ç¡®ä¸€ä¸‹ <code>completeWork</code> çš„ç›®çš„ï¼š</p><ol><li><strong>ä¸º <code>HostComponent</code> å’Œ <code>HostText</code> æ„å»ºç¦»å± DOM æ ‘</strong></li><li><strong>æ¯ä¸ª fiber éœ€è¦è®°å½•å…¶å­æ ‘çš„ flags</strong></li></ol><h3 id="ä¸ºä»€ä¹ˆæ˜¯åœ¨-completework-æ—¶æ„å»ºç¦»å±-dom-æ ‘" tabindex="-1">ä¸ºä»€ä¹ˆæ˜¯åœ¨ completeWork æ—¶æ„å»ºç¦»å± DOM æ ‘ï¼Ÿ <a class="header-anchor" href="#ä¸ºä»€ä¹ˆæ˜¯åœ¨-completework-æ—¶æ„å»ºç¦»å±-dom-æ ‘" aria-hidden="true">#</a></h3><p>å› ä¸º completeWork æ˜¯å¯¹ wip fiber tree è¿›è¡Œè‡ªä¸‹è€Œä¸Šéå†çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åœ¨ completeWork æ—¶ï¼Œå­ fiber æ˜¯å·²ç»ç”Ÿæˆå¥½çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ—¶å€™åˆ›å»ºçœŸå® DOM Tree</p><p>å¹¶ä¸”ç”±äºè¿™äº› fiber éƒ½æ˜¯æ²¡æœ‰ <code>Placement</code> æ ‡è®°çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šè¢« commit é˜¶æ®µå¤„ç†ï¼Œè€Œæ˜¯ä½œä¸ºä¸€æ•´æ£µå­˜åœ¨äºå†…å­˜ä¸­çš„ç¦»å± DOM Treeï¼Œæœ€ç»ˆåœ¨ <code>hostRootFiber.child</code> è¢«æ¸²æŸ“åˆ° UI æ—¶ä¸€æ¬¡æ€§å°†æ•´ä¸ªç¦»å± DOM Tree æ¸²æŸ“åˆ° UI ä¸­</p><h3 id="ä¸ºä»€ä¹ˆè¦è®°å½•æ¯ä¸ª-fiber-çš„å­æ ‘-flags" tabindex="-1">ä¸ºä»€ä¹ˆè¦è®°å½•æ¯ä¸ª fiber çš„å­æ ‘ flagsï¼Ÿ <a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¦è®°å½•æ¯ä¸ª-fiber-çš„å­æ ‘-flags" aria-hidden="true">#</a></h3><p>è¯•æƒ³ä¸€ä¸‹ï¼Œå½“ wip fiber tree ç”Ÿæˆå®Œæ¯•åï¼Œcommit é˜¶æ®µæ˜¯ä¸æ˜¯éœ€è¦å¯¹è¢«æ ‡è®°çš„ fiber å¯¹åº”çš„ DOM å…ƒç´ æ‰§è¡Œ flags å¯¹åº”çš„ DOM æ“ä½œï¼Ÿé‚£é¦–å…ˆå°±é‡åˆ°ä¸€ä¸ªé—®é¢˜äº†ï¼Œè¦æ€ä¹ˆæ‰¾åˆ°è¿™äº›æ•£è½åœ¨ wip fiber tree ä¸­å„ä¸ª fiber èŠ‚ç‚¹ä¸Šçš„ flags?</p><p>å¦‚æœé€šè¿‡ä» hostRootFiber å¼€å§‹å¾€ä¸‹éå†ä¸æ–­æ”¶é›† flags çš„è¯ï¼Œåœ¨ fiber tree ç»“æ„æ¯”è¾ƒå¤æ‚æ—¶ï¼Œéå†è€—æ—¶æ¯”è¾ƒä¹…ï¼Œæ€§èƒ½ä¸å¤ªå¥½</p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>completeWork</code> ä»¥åŠ <code>ä½è¿ç®—</code> çš„ç‰¹ç‚¹å»å®Œæˆ flags çš„æ”¶é›†ï¼Œåªéœ€è¦ç»™ FiberNode åŠ ä¸€ä¸ª <code>subtreeFlags</code> å±æ€§</p><p>ç„¶ååœ¨ completeWork çš„æ—¶å€™å…¶æ˜¯è‡ªä¸‹è€Œä¸Šéå† wip fiber tree çš„ï¼Œæ‰€ä»¥åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæˆ‘ä»¬éƒ½èƒ½å¤Ÿè·å–åˆ°å…¶å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåªéœ€è¦å°†å­èŠ‚ç‚¹çš„ <code>subtreeFlags</code> ä»¥åŠå­èŠ‚ç‚¹çš„ <code>flags</code> é€šè¿‡ <code>æŒ‰ä½æˆ–è¿ç®—</code> å°†å…¶èµ‹å€¼åˆ°å½“å‰èŠ‚ç‚¹çš„ <code>subtreeFlags</code> å±æ€§ä¸Š</p><p>è¿™æ ·ä¸€æ¥éšç€ completeWork ä¸æ–­å¾€ä¸Šéå†ï¼Œæœ€ç»ˆéå†å› hostRootFiber èŠ‚ç‚¹æ—¶ï¼Œå…¶ <code>subtreeFlags</code> å±æ€§å°±æ”¶é›†åˆ°äº†æ•´é¢— wip fiber tree çš„ flags</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ commit é˜¶æ®µæ—¶æ— è®ºå¤„åœ¨å“ªä¸ªèŠ‚ç‚¹ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“å½“å‰è¿™é¢—å­æ ‘æœ‰å“ªäº›å‰¯ä½œç”¨æ ‡è®°æ“ä½œè¦æ‰§è¡Œ</p><p>äº‹å®ä¸Šï¼Œè¿™ä¸€æµç¨‹åœ¨ React ä¸­è¢«ç§°ä¸º â€œflags å†’æ³¡â€ï¼Œåœ¨ <code>bubbleProperties</code> å‡½æ•°ä¸­å®ç°</p><h3 id="appendallchildren-æ„å»º-dom-tree" tabindex="-1">appendAllChildren -- æ„å»º DOM Tree <a class="header-anchor" href="#appendallchildren-æ„å»º-dom-tree" aria-hidden="true">#</a></h3><p>ä» DOM æ¸²æŸ“çš„è§’åº¦æ¥çœ‹ï¼Œ<code>appendAllChildren</code> å‡½æ•°æ˜¯å°†æ‰€æœ‰çš„å­å…ƒç´ æ·»åŠ åˆ°å®¹å™¨å…ƒç´ ä¸­ï¼Œè€Œç”±äºæˆ‘ä»¬æ“ä½œçš„å·¥ä½œå•å…ƒæ˜¯ fiberï¼Œæ‰€ä»¥è¯¥å‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">appendAllChildren</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">parent</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">HTMLElement</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span></code></pre></div><p>å‡è®¾ç°åœ¨çš„æ¸²æŸ“åœºæ™¯æ˜¯è¿™æ ·çš„ï¼š</p><div class="language-tsx"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> Foo</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FC</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">foo</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> Bar</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FC</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">bar</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> App</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FC</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Foo</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Bar</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#F07178;">  )</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">ReactDOM</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createRoot</span><span style="color:#A6ACCD;">(document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getElementById</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">))</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">App</span><span style="color:#89DDFF;"> /&gt;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>å‡è®¾æ­¤æ—¶ <code>parent</code> æ˜¯ <code>&lt;App /&gt;</code> ä¸­çš„ <code>&lt;div&gt;</code>ï¼Œ<code>workInProgress</code> æ˜¯ <code>&lt;Foo /&gt;</code> å¯¹åº”çš„ fiberï¼Œé‚£ä¹ˆæˆ‘ä»¬éš¾é“æ˜¯å°† <code>&lt;Foo /&gt;</code> è¿™æ ·çš„å…ƒç´ æ·»åŠ åˆ° parent æŒ‡å‘çš„ <code>&lt;div&gt;</code> ä¸­å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°çš„ DOM ç»“æ„åº”å½“æ˜¯å°† <code>&lt;Foo /&gt;</code> ä¸­çš„ <code>&lt;div&gt;</code> æ·»åŠ åˆ° parent æŒ‡å‘çš„ <code>&lt;div&gt;</code> ä¸­</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ä» fiber ä¸­æŸ¥æ‰¾åŒçº§çš„ DOM å…ƒç´ ï¼Œå¯èƒ½éœ€è¦è·¨ fiber å±‚çº§æŸ¥æ‰¾</strong>ï¼Œå³ <strong>fiber çš„å±‚çº§ä¸ DOM å…ƒç´ çš„å±‚çº§å¯èƒ½ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„</strong></p><p>å› æ­¤ appendAllChildren çš„å®ç°åº”å½“æ˜¯ä¸€ä¸ªå’Œ fiber éå†æµç¨‹ç›¸åŒçš„é€’å½’æµç¨‹ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ¸²æŸ“çš„æ˜¯ <code>&lt;div&gt;</code> è¿™æ ·çš„ DOM å…ƒç´ è€Œä¸æ˜¯ <code>&lt;Foo /&gt;</code> è¿™æ ·çš„å…ƒç´ </p><p>ç»¼ä¸Šæ‰€è¿°ï¼ŒappendAllChildren çš„å®ç°å¦‚ä¸‹ï¼š</p><p><code>packages/react-reconciler/src/complete-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> å°† workInProgress çš„ fiber å¯¹åº”çš„çœŸå® DOM æ·»åŠ åˆ° parent ä¸­</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">parent</span><span style="color:#676E95;font-style:italic;"> HTML å®¹å™¨å…ƒç´ </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> å¾…ç¦»å±æ¸²æŸ“çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">appendAllChildren</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">parent</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">HTMLElement</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// node æ˜¯ DOM å¯¹åº”çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostComponent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostText</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// å¾€ parent ä¸­æ’å…¥ DOM å…ƒç´ </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">appendInitialChild</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">parent</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// node ä¸æ˜¯ DOM å¯¹åº”çš„ fiberï¼Œå¾€ child éå†å¯»æ‰¾ DOM å¯¹åº”çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">continue</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// base case 1: éå†åˆ° parent å¯¹åº”çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœæ²¡æœ‰å…„å¼Ÿ fiberï¼Œåˆ™å‘çˆ¶ fiber éå†å¯»æ‰¾ DOM å¯¹åº”çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sibling</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// base case 2: å›åˆ° hostRootFiber æˆ– å›åˆ° parent å¯¹åº”çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">return</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// éå†å…„å¼Ÿ fiber å¯»æ‰¾ DOM å¯¹åº”çš„ fiber</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sibling</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sibling</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŠŠ appendAllChildren æ•´åˆåˆ° completeWork ä¸­äº†</p><p><code>packages/react-reconciler/src/complete-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> workLoop çš„é€’å½’ä¸­çš„ \`å½’\` é˜¶æ®µ</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *              - mount æ—¶è¿›è¡Œç¦»å±æ¸²æŸ“</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *              - ä¸ºæ¯ä¸ª fiber è®°å½• subtreeFlags</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">completeWork</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pendingProps</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostRoot</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostComponent</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// update</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// mount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// instance æ˜¯æŠ½è±¡å‡ºæ¥çš„å¹³å°æ— å…³çš„èŠ‚ç‚¹å®ä¾‹ -- æ¯”å¦‚ DOM ä¸­åˆ›å»º HTMLDivElement</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createInstance</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newProps</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">appendAllChildren</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// fiber çš„ stateNode æŒ‡å‘ DOM</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostText</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// update</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// mount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// textInstance æ˜¯æŠ½è±¡å‡ºæ¥çš„å¹³å°æ— å…³çš„æ–‡æœ¬èŠ‚ç‚¹å®ä¾‹ -- æ¯”å¦‚ DOM ä¸­åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ Text</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">textInstance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createTextInstance</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newProps</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// HostText ä¸å­˜åœ¨ childï¼Œæ‰€ä»¥ä¸éœ€è¦è°ƒç”¨ appendAllChildren</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// appendAllChildren(textInstance, workInProgress)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// fiber çš„ stateNode æŒ‡å‘ DOM</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">textInstance</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">completeWork: å°šæœªå®ç°çš„ completeWork æƒ…å†µ</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        )</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>è¿™é‡ŒæŠŠå…·ä½“çš„ DOM ç›¸å…³çš„æ“ä½œæŠ½è±¡æˆå¹³å°æ— å…³çš„æ“ä½œï¼Œå‰é¢æˆ‘ä»¬å·²ç»å°†å¹³å°æ— å…³çš„ä»£ç éƒ½æ”¾åˆ° <code>host-config.ts</code> ä¸­ç»´æŠ¤äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆéšæ„ç»™ä¸€ä¸ªå®ç°ï¼Œä¹‹ååœ¨å®ç° <code>ReactDOM</code> çš„æ—¶å€™å†å…·ä½“å»å®ç°å®ƒä»¬</p><p><code>packages/react-reconciler/src/host-config.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> åˆ›å»ºå…·ä½“å¹³å°å®ä¾‹ -- æ¯”å¦‚åˆ›å»º DOM å…ƒç´ </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createInstance</span><span style="color:#89DDFF;">(...</span><span style="color:#A6ACCD;font-style:italic;">args</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> åˆ›å»ºå…·ä½“å¹³å°çš„æ–‡æœ¬å®ä¾‹ -- æ¯”å¦‚åˆ›å»º DOM ä¸­çš„ Text</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createTextInstance</span><span style="color:#89DDFF;">(...</span><span style="color:#A6ACCD;font-style:italic;">args</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> å¾€ parent ä¸­æ’å…¥å…ƒç´ </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">appendInitialChild</span><span style="color:#89DDFF;">(...</span><span style="color:#A6ACCD;font-style:italic;">args</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="flags-å†’æ³¡" tabindex="-1">flags å†’æ³¡ <a class="header-anchor" href="#flags-å†’æ³¡" aria-hidden="true">#</a></h3><p>å‰é¢åˆ†æçš„æ—¶å€™è¯´è¿‡è¦ç»™ FiberNode æ·»åŠ ä¸€ä¸ª <code>subtreeFlags</code> å±æ€§ï¼Œå…¶ä½œç”¨æ˜¯è®°å½• fiber çš„å­æ ‘ä¸­æ‰€æœ‰ fiber çš„ flags</p><p><code>packages/react-reconciler/src/fiber.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-diff"><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ...</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">subtreeFlags</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Flags</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">tag</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WorkTag</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">pendingProps</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Props</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Key</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Effects</span></span>
<span class="line diff add"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NoFlags</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>åŒæ—¶è¿˜è¦åœ¨ <code>createWorkInProgress</code> ä¸­æ¸…é™¤å‰¯ä½œç”¨ç›¸å…³å±æ€§æ—¶å°† subtreeFlags ä¹Ÿæ¸…é™¤</p><p><code>packages/react-reconciler/src/fiber.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-diff"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createWorkInProgress</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">current</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">pendingProps</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Props</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">wip</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">wip</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// mount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// é¦–æ¬¡æŒ‚è½½æ—¶ä¸å­˜åœ¨ current.alternateï¼Œå› æ­¤åˆå§‹åŒ–åˆ›å»ºä¸€ä¸ª</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">wip</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">FiberNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">HostRoot</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pendingProps</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// hostRootFiber çš„ stateNode æŒ‡å‘ FiberRootNode</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å»ºç«‹åŒç¼“å†²çš„ä¸¤æ£µ fiber tree ä¹‹é—´çš„è”ç³»</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">wip</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// update</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pendingProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pendingProps</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ¸…é™¤å‰¯ä½œç”¨ç›¸å…³å±æ€§</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NoFlags</span></span>
<span class="line diff add"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NoFlags</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å‘æŒ¥åŒç¼“å†²çš„ç‰¹æ€§ï¼Œå°½å¯èƒ½å¤ç”¨ current ä¸Šçš„å±æ€§</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updateQueue</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedProps</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">wip</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">memoizedState</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">wip</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç„¶åå°±å¯ä»¥å®ç° <code>bubbleProperties</code> å‡½æ•°äº†ï¼Œåœ¨è¯¥å‡½æ•°ä¸­æˆ‘ä»¬ä¼šå®Œæˆ <code>flags å†’æ³¡</code> çš„æ“ä½œ</p><p><code>packages/react-reconciler/src/complete-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> flags å†’æ³¡ -- æ”¶é›† workInProgress å­ fiber tree çš„ flags</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#676E95;font-style:italic;"> å¾…æ“ä½œ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bubbleProperties</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NoFlags</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">child</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ”¶é›† child çš„å­æ ‘ flags</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">child</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">subtreeFlags</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ”¶é›† child è‡ªèº«çš„ flags</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">child</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">flags</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å»ºç«‹ child å’Œ workInProgress çš„è”ç³»</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">child</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ”¶é›† sibling çš„ subtreeFlags</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">child</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">child</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sibling</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å°†æ”¶é›†ç»“æœå­˜å…¥ workInProgress ä¸­</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">subtreeFlags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">subtreeFlags</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç„¶ååœ¨ completeWork ä¸­è°ƒç”¨å®ƒ</p><p><code>packages/react-reconciler/src/complete-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-focused-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">completeWork</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newProps</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pendingProps</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostRoot</span><span style="color:#89DDFF;">:</span></span>
<span class="line has-focus"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">bubbleProperties</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">) </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostComponent</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// update</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// mount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// instance æ˜¯æŠ½è±¡å‡ºæ¥çš„å¹³å°æ— å…³çš„èŠ‚ç‚¹å®ä¾‹ -- æ¯”å¦‚ DOM ä¸­åˆ›å»º HTMLDivElement</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createInstance</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newProps</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">appendAllChildren</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// fiber çš„ stateNode æŒ‡å‘ DOM</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line has-focus"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">bubbleProperties</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">) </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HostText</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// update</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// mount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// textInstance æ˜¯æŠ½è±¡å‡ºæ¥çš„å¹³å°æ— å…³çš„æ–‡æœ¬èŠ‚ç‚¹å®ä¾‹ -- æ¯”å¦‚ DOM ä¸­åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ Text</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">textInstance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createTextInstance</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newProps</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// HostText ä¸å­˜åœ¨ childï¼Œæ‰€ä»¥ä¸éœ€è¦è°ƒç”¨ appendAllChildren</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// appendAllChildren(textInstance, workInProgress)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// fiber çš„ stateNode æŒ‡å‘ DOM</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">textInstance</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line has-focus"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">bubbleProperties</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#F07178;">) </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">completeWork: å°šæœªå®ç°çš„ completeWork æƒ…å†µ</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">workInProgress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        )</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>flags å†’æ³¡å®Œåï¼Œåœ¨ä»»æ„ä¸€ä¸ª fiber ä¸­éƒ½èƒ½å¤Ÿé€šè¿‡ <code>subtreeFlags</code> å±æ€§çŸ¥é“ä»¥è¯¥ fiber ä¸ºæ ¹èŠ‚ç‚¹çš„ fiber tree æ˜¯å¦å­˜åœ¨å‰¯ä½œç”¨éœ€è¦å¤„ç†ï¼Œæ–¹ä¾¿ commit é˜¶æ®µçš„æ—¶å€™ä½¿ç”¨</p><h2 id="å¯¹æ¥-commitroot" tabindex="-1">å¯¹æ¥ commitRoot <a class="header-anchor" href="#å¯¹æ¥-commitroot" aria-hidden="true">#</a></h2><p>ç°åœ¨æˆ‘ä»¬çš„ reconciler å°±ç®—å®Œæˆäº†ï¼Œä¹Ÿå°±æ˜¯ render é˜¶æ®µç®—æ˜¯å®ç°äº†ï¼Œæ¥ä¸‹æ¥çš„æµç¨‹è¦äº¤ç»™ commit é˜¶æ®µå»å¤„ç†ï¼Œæˆ‘ä»¬å…ˆä¸å…¶å¯¹æ¥ä¸€ä¸‹ï¼Œè‡³äº commit é˜¶æ®µçš„å®ç°ï¼Œä¼šåœ¨ä¸‹ç¯‡æ–‡ç« ä¸­è®²è§£</p><p>è¦å¦‚ä½•å¯¹æ¥å‘¢ï¼Ÿcommit é˜¶æ®µè‚¯å®šéœ€è¦è·å–åˆ°æ•´é¢—è°ƒå’Œå¥½äº†çš„ fiber treeï¼Œæˆ‘ä»¬å°†è°ƒå’Œå¥½çš„ fiber treeï¼Œä¹Ÿå°±æ˜¯ <code>workLoop</code> ç»“æŸåçš„ <code>workInProgress</code> æŒ‚è½½åˆ° <code>FiberRootNode</code> çš„ <code>finishedWork</code> å±æ€§ä¸Šï¼Œå†å°†æ•´ä¸ª FiberRootNode äº¤ç»™ <code>commitRoot</code> å‡½æ•°å³å¯</p><p>è€Œ <code>workInProgress</code> å¯ä»¥é€šè¿‡ <code>root.current.alternate</code> è·å–åˆ°ï¼Œå› ä¸ºæ— è®ºæ—¶è°ƒå’Œä¹‹å‰è¿˜æ˜¯è°ƒå’Œä¹‹åï¼Œ<code>root.current</code> éƒ½æ˜¯æŒ‡å‘æ—§ fiber tree çš„ <code>hostRootFiber</code> çš„ï¼Œé€šè¿‡å…¶ <code>alternate</code> å±æ€§å³å¯è·å–åˆ°è°ƒå’Œåçš„ <code>hostRootFiber</code>ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><code>packages/react-reconciler/src/complete-work.ts</code></p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-focused-lines"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">description</span><span style="color:#676E95;font-style:italic;"> æ¸²æŸ“æ ¹å…ƒç´  -- å·¥ä½œæµå…¥å£</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">root</span><span style="color:#676E95;font-style:italic;"> æ ¹å…ƒç´ çš„ fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">renderRoot</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">root</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberRootNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">prepareFreshStack</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¼€å¯å·¥ä½œå¾ªç¯</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">workLoop</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line has-focus"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å·¥ä½œå¾ªç¯ç»“æŸåè¯´æ˜ reconcile å®Œæ¯• -- æ›´æ–° roo.finishedWork æŒ‡å‘å®Œæ•´çš„ä»¥ hostRootFiber ä¸ºæ ¹èŠ‚ç‚¹çš„ fiber tree </span></span>
<span class="line has-focus"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;"> </span></span>
<span class="line"></span>
<span class="line has-focus"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ¥ä¸‹æ¥äº¤ç»™ commit é˜¶æ®µå»æ ¹æ® reconcile æ—¶ç»™æ¯ä¸ª fiber æ‰“ä¸Šçš„ flags å»è¿›è¡Œå®¿ä¸»ç¯å¢ƒä¸­çš„æ¸²æŸ“ </span></span>
<span class="line has-focus"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">commitRoot</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#F07178;">) </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æœ‰ <code>__DEV__</code> å…¨å±€æ ‡è¯†ï¼Œè€Œæˆ‘ä»¬æ— æ³•ä¿è¯ <code>workLoop()</code> çš„æ‰§è¡Œä¼šæœ‰ä»€ä¹ˆé¢„æœŸä¹‹å¤–çš„é”™è¯¯ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ <code>try catch</code> åŒ…è£¹å¤„ç†ä¸€ä¸‹ï¼Œå¹¶ä¸”åœ¨å¼€å‘ç¯å¢ƒä¸‹è¾“å‡ºé”™è¯¯ä¿¡æ¯</p><div class="language-TypeScript"><button title="Copy Code" class="copy"></button><span class="lang">TypeScript</span><pre class="shiki material-palenight has-focused-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">renderRoot</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">root</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FiberRootNode</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">prepareFreshStack</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line has-focus"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¼€å¯å·¥ä½œå¾ªç¯ </span></span>
<span class="line has-focus"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">workLoop</span><span style="color:#F07178;">() </span></span>
<span class="line has-focus"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">error</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">workLoop å‘ç”Ÿé”™è¯¯:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">error</span><span style="color:#F07178;">) </span></span>
<span class="line has-focus"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span></span>
<span class="line has-focus"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å·¥ä½œå¾ªç¯ç»“æŸåè¯´æ˜ reconcile å®Œæ¯• -- æ›´æ–° roo.finishedWork æŒ‡å‘å®Œæ•´çš„ä»¥ hostRootFiber ä¸ºæ ¹èŠ‚ç‚¹çš„ fiber tree</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ¥ä¸‹æ¥äº¤ç»™ commit é˜¶æ®µå»æ ¹æ® reconcile æ—¶ç»™æ¯ä¸ª fiber æ‰“ä¸Šçš„ flags å»è¿›è¡Œå®¿ä¸»ç¯å¢ƒä¸­çš„æ¸²æŸ“</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// commitRoot(root)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>æœ¬ç¯‡æ–‡ç« å¯¹åº”ä»£ç å¯ä»¥åˆ° <a href="https://github.com/plasticine-yang/plasticine-react/tree/03_first-screen-rendering" target="_blank" rel="noreferrer">03_first-screen-rendering</a> åˆ†æ”¯æŸ¥çœ‹</p></div>`,172),t=[e];function c(r,y,F,i,D,C){return a(),n("div",null,t)}const f=s(p,[["render",c]]);export{d as __pageData,f as default};
